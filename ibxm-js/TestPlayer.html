<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>IBXM for JavaScript</title>
	</head>
	<body onload="init()">
		<script type="text/javascript" src="AudioPlayer.js"></script>
		<script type="text/javascript" src="IBXM.js"></script>
		<script type="text/javascript" src="PatternDisplay.js"></script>
		<script type="text/javascript">
			var ibxmModule, ibxmReplay;
			var patternDisplay, patternCanvas;
			var audioPlayer = new AudioPlayer();
			var latency = audioPlayer.getBufferSize() * 1000 / audioPlayer.getSamplingRate();
			var interval;
			function init() {
				patternCanvas = document.getElementById( "patternCanvas" )
				initCharset( document.getElementById( "patternCharset" ),
					function( chs ) {
						patternDisplay = new PatternDisplay( chs );
					}
				);
			}
			function clearDisplay() {
				var ctx = patternCanvas.getContext( "2d" );
				ctx.fillStyle = "black";
				ctx.fillRect( 0, 0, patternCanvas.width, patternCanvas.height );
			}
			function updateDisplay() {
				var pat = ibxmModule.sequence[ ibxmReplay.getSequencePos() ];
				var row = ibxmReplay.getRow();
				setTimeout( patternDisplay.display, latency, ibxmModule, pat, row, patternCanvas );
			}
			function play() {
				audioPlayer.play();
				interval = setInterval( updateDisplay, 100 );
			}
			function stop() {
				clearInterval( interval );
				audioPlayer.stop();
			}
			function setModule( moduleData ) {
				stop();
				ibxmModule = new IBXMModule( moduleData );
				ibxmReplay = new IBXMReplay( ibxmModule, audioPlayer.getSamplingRate() );
				ibxmReplay.setInterpolation( false );
				var duration = Math.round( ibxmReplay.calculateSongDuration() / audioPlayer.getSamplingRate() );
				audioPlayer.setAudioSource( ibxmReplay );
				document.getElementById( "songName" ).innerHTML = "Song Name: " + ibxmModule.songName;
				document.getElementById( "duration" ).innerHTML = "Duration: " + duration + " seconds.";
				clearDisplay();
				updateDisplay();
			}
			function loadFile( file ) {
				var reader = new FileReader();
				reader.onloadend = function( event ) {
					setModule( new Int8Array( reader.result ) );
				};
				reader.readAsArrayBuffer( file );
			}
			function loadURL( url ) {
				var request = new XMLHttpRequest();
				request.open( "GET", url, true );
				request.responseType = "arraybuffer";
				request.onload = function( event ) {
					setModule( new Int8Array( request.response ) );
				};
				request.send( null );
			}
		</script>
		<p>
			<h3>IBXM for JavaScript!</h3>
		</p>
		<p>
			Please direct any comments, questions, complaints :) to mumart@gmail.com
		</p>
		<p>
			<div id="songName">No song loaded.</div>
		</p>
		<p>
			<div id="duration"></div>
		</p>
		<p>
			<input type="file" id="input" onchange="loadFile( this.files[ 0 ] )"></input>
			<button onclick="play()">Play</button>
			<button onclick="stop()">Stop</button>
		</p>
		<img id="patternCharset" src="topaz8.png" hidden="true"></img>
		<canvas id="patternCanvas" width="736" height="256"></canvas>
	</body>
</html>
